{
  "name": "Email Triage v5",
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "filters": {}
      },
      "id": "836a04c8-e963-49da-9146-e4d701a38a80",
      "name": "Nouveau Email ReÃ§u1",
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1.3,
      "position": [
        -9968,
        4880
      ],
      "credentials": {
        "gmailOAuth2": {
          "id": "ZiybzjxKNB9gi1CO",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un agent de tri du service client.\n\nAnalyse l'intention globale du client (le sens de la demande), pas seulement des mots isolÃ©s.\nRetourne UNIQUEMENT un objet JSON valide, sans texte autour.\n\nTu dois choisir OBLIGATOIREMENT le champ \"type\" parmi : \"remboursement\", \"livraison\", \"autre\".\n\nRetourne EXACTEMENT ce format :\n{\n  \"type\": \"remboursement | livraison | autre\",\n  \"resume\": \"resume clair et factuel\",\n  \"priorite\": \"faible | moyenne | elevee\"\n}\n\nOrdre de dÃ©cision strict :\n1) Si l'intention principale est de rÃ©cupÃ©rer son argent / annuler et Ãªtre remboursÃ© => type = \"remboursement\"\n2) Sinon, si l'intention principale concerne l'acheminement du colis (retard, statut, non-rÃ©ception, suivi) => type = \"livraison\"\n3) Sinon => type = \"autre\"\n\nRÃ¨gles de raisonnement :\n- Fais un choix selon l'idÃ©e dominante du message, mÃªme si certains mots-clÃ©s sont absents.\n- En cas de message mixte, applique la prioritÃ© : remboursement > livraison > autre.\n- Les questions produit, guide/ebook/PDF, provenance, SAV gÃ©nÃ©ral, informations, etc. vont dans \"autre\" sauf si l'intention principale est clairement remboursement ou livraison.\n\nMessage client : {{ $json.text || $json.body || $json.snippet }}\n",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "Tu es un assistant de triage email service client. Ta sortie doit Ãªtre strictement un JSON valide, avec uniquement les champs type, resume, priorite. Classe par intention principale (sens global), pas par simple prÃ©sence de mots. PrioritÃ© stricte en cas d'ambiguÃ¯tÃ©: remboursement > livraison > autre. Ne retourne jamais d'autre clÃ©."
        }
      },
      "id": "e7cfa3d7-ff5b-4e1d-adeb-4de827eab0db",
      "name": "Analyse Email - Classification1",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -8912,
        4848
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "id": "1e179e19-9014-4545-ade4-df8921945a29",
      "name": "OpenAI Chat Model2",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        -9040,
        5456
      ],
      "credentials": {
        "openAiApi": {
          "id": "a1M3DJWKMxTixZzN",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "id": "75d832bb-a83a-4c64-849a-9a69d748ebbe",
      "name": "OpenAI Chat Model4",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        -7568,
        5664
      ],
      "credentials": {
        "openAiApi": {
          "id": "a1M3DJWKMxTixZzN",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "v5-liv-type",
                    "leftValue": "={{$json.type}}",
                    "rightValue": "livraison",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "v5-remb-type",
                    "leftValue": "={{$json.type}}",
                    "rightValue": "remboursement",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "v5-autre-type",
                    "leftValue": "={{$json.type}}",
                    "rightValue": "autre",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -8016,
        4688
      ],
      "id": "b934523c-3c7d-4265-a2d1-a5b43bc46fdd",
      "name": "triage mail 1"
    },
    {
      "parameters": {
        "jsCode": "const input = $json;\n\nfunction normalizeType(rawType) {\n  const value = (rawType || '').toString().trim().toLowerCase().normalize('NFD').replace(/[Ì€-Í¯]/g, '');\n\n  if (['remboursement', 'refund', 'rembourser', 'retour-remboursement'].includes(value)) return 'remboursement';\n  if (['livraison', 'delivery', 'expedition', 'suivi-colis'].includes(value)) return 'livraison';\n  if (['autre', 'other'].includes(value)) return 'autre';\n\n  return 'autre';\n}\n\nfunction tryParseJson(str) {\n  try { return JSON.parse(str); } catch { return null; }\n}\n\nfunction extractBalancedJsonObject(text) {\n  const start = text.indexOf('{');\n  if (start < 0) return null;\n\n  let depth = 0;\n  let inString = false;\n  let escaped = false;\n\n  for (let i = start; i < text.length; i++) {\n    const ch = text[i];\n\n    if (inString) {\n      if (escaped) {\n        escaped = false;\n      } else if (ch === '\\\\') {\n        escaped = true;\n      } else if (ch === '\"') {\n        inString = false;\n      }\n      continue;\n    }\n\n    if (ch === '\"') {\n      inString = true;\n      continue;\n    }\n\n    if (ch === '{') depth++;\n    if (ch === '}') {\n      depth--;\n      if (depth === 0) return text.slice(start, i + 1);\n    }\n  }\n\n  return null;\n}\n\nfunction parseModelOutput(rawOutput) {\n  if (rawOutput && typeof rawOutput === 'object') return rawOutput;\n\n  const text = (rawOutput || '').toString().trim();\n  if (!text) return null;\n\n  const candidates = [text];\n\n  const fenced = text.match(/```(?:json)?\\s*([\\s\\S]*?)```/i);\n  if (fenced && fenced[1]) candidates.push(fenced[1].trim());\n\n  const balanced = extractBalancedJsonObject(text);\n  if (balanced) candidates.push(balanced.trim());\n\n  for (const c of candidates) {\n    const parsed = tryParseJson(c);\n    if (parsed && typeof parsed === 'object') return parsed;\n  }\n\n  return null;\n}\n\nconst parsed = parseModelOutput(input.output);\nconst payload = parsed || {};\n\nconst normalizedType = normalizeType(payload.type);\nconst priorityRaw = (payload.priorite || '').toString().trim().toLowerCase();\nconst normalizedPriorite = ['faible', 'moyenne', 'elevee'].includes(priorityRaw) ? priorityRaw : 'faible';\n\nconst resumeRaw = payload.resume || payload.summary || payload.explanation || input.resume || '';\nconst resume = resumeRaw\n  ? resumeRaw.toString().trim()\n  : 'Demande client a traiter.';\n\nreturn [{\n  json: {\n    ...input,\n    type: normalizedType,\n    resume,\n    priorite: normalizedPriorite\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8304,
        4736
      ],
      "id": "5f264ad7-c216-4725-9b59-d8ea912de85d",
      "name": "Parse IA Outpu1"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        -7568,
        4448
      ],
      "id": "f522e328-f687-4415-9de9-e8470d8018b8",
      "name": "OpenAI Chat Model5",
      "credentials": {
        "openAiApi": {
          "id": "a1M3DJWKMxTixZzN",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un agent du service client de {{ $node[\"Client Configuration1\"].json.brand_name }}.\n\nRÃ©dige un brouillon dâ€™email professionnel en franÃ§ais pour rÃ©pondre Ã  un client concernant un problÃ¨me de livraison.\n\nRÃ¨gles obligatoires :\n- Ton formel (vous)\n- RÃ©ponse factuelle et concise\n- Inclure explicitement cette phrase d'excuse (sans la reformuler) : {{ $node[\"Client Configuration1\"].json.apology_livraison }}\n- Ne pas promettre de date de livraison prÃ©cise\n- Expliquer que le retard peut Ãªtre liÃ© Ã  {{ $node[\"Client Configuration1\"].json.delay_reason }}\n- Indiquer quâ€™un message du transporteur sera envoyÃ© dÃ¨s quâ€™une mise Ã  jour sera disponible\n- Signature obligatoire : {{ $node[\"Client Configuration1\"].json.support_signature }}\n\nContexte destinataire :\n- Nom : {{ $json.client_name || $node[\"Nouveau Email ReÃ§u1\"].json.client_name || $node[\"Nouveau Email ReÃ§u1\"].json.From }}\n- Email : {{ $json.client_email || $json.from || $node[\"Nouveau Email ReÃ§u1\"].json.From }}\n- Sujet reÃ§u : {{ $json.subject || $node[\"Nouveau Email ReÃ§u1\"].json.Subject || $json.subject }}\n\nRÃ©sumÃ© du problÃ¨me :\n{{ $json.resume }}\n",
        "hasOutputParser": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -7824,
        3744
      ],
      "id": "81517331-75ee-4803-890d-0489c1edf288",
      "name": "Draft â€“ Livraison1",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un agent du service client de {{ $node[\"Client Configuration1\"].json.brand_name }}.\n\nRÃ©dige un brouillon dâ€™email factuel et concis en franÃ§ais.\n\nCe type de rÃ©ponse est utilisÃ© pour les questions hors livraison/remboursement (provenance, guide, questions produit).\n\nRÃ¨gle PRIORITAIRE (cas guide manquant) :\n- Si le client parle d'un guide manquant/non reÃ§u (guide, manuel, e-book, ebook, PDF, piÃ¨ce jointe absente), retourne EXACTEMENT ce message (sans modification) :\n\nBonjour,\n\nMerci pour votre message.\n\n{{ $node[\"Client Configuration1\"].json.guide_delivery_note }}\n\nNous vous le transmettons en piÃ¨ce jointe Ã  ce message afin que vous puissiez en profiter immÃ©diatement.\n\nNâ€™hÃ©sitez pas Ã  nous confirmer sa bonne rÃ©ception.\n\nCordialement,\n{{ $node[\"Client Configuration1\"].json.support_signature }}\n\nRÃ¨gles obligatoires (hors cas prioritaire) :\n- Inclure explicitement cette phrase d'excuse (sans la reformuler) : {{ $node[\"Client Configuration1\"].json.apology_autre }}\n- Ne faire aucune supposition sur la situation du client\n- Ne fixer aucun dÃ©lai\n- Ne faire aucune promesse\n- Signature obligatoire : {{ $node[\"Client Configuration1\"].json.support_signature }}\n\nContexte destinataire :\n- Nom : {{ $json.client_name || $node[\"Nouveau Email ReÃ§u1\"].json.client_name || $node[\"Nouveau Email ReÃ§u1\"].json.From }}\n- Email : {{ $json.client_email || $json.from || $node[\"Nouveau Email ReÃ§u1\"].json.From }}\n\nMessage client :\n{{ $json.text || $json.body || $json.snippet || $json.resume }}\n",
        "options": {
          "systemMessage": "Tu es un assistant IA de service client. Tu dois suivre strictement les rÃ¨gles du prompt utilisateur.\n\nPrioritÃ© absolue : si la demande concerne un guide manquant/non reÃ§u (guide, manuel, e-book, ebook, PDF, piÃ¨ce jointe absente), tu renvoies exactement le message fourni, sans rien ajouter ni retirer.\n\nSinon, rÃ©dige une rÃ©ponse factuelle, concise et sans formulation Ã©motionnelle."
        }
      },
      "id": "01ea2acc-1303-4c58-9976-6295fc4e55af",
      "name": "Draft â€“ Autre1",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -7552,
        5008
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "id-1",
              "name": "support_signature",
              "value": "Service client â€“ Novea Paris",
              "type": "string"
            },
            {
              "id": "db55be54-987a-47a9-97aa-5b010b92398a",
              "name": "brand_name",
              "value": "Novea Paris",
              "type": "string"
            },
            {
              "id": "f5cd701a-a6b0-4994-a30a-4f41698cea21",
              "name": "delay_reason",
              "value": "des perturbations logistiques temporaires chez le transporteur",
              "type": "string"
            },
            {
              "id": "cfg-review_chat_id",
              "name": "review_chat_id",
              "value": "7651454520",
              "type": "string"
            },
            {
              "id": "cfg-support-email",
              "name": "support_email",
              "value": "support@noveaparis.com",
              "type": "string"
            },
            {
              "id": "cfg-refund-docs",
              "name": "refund_required_items",
              "value": "- La raison prÃ©cise du retour\n- Une photo claire de chaque article concernÃ©",
              "type": "string"
            },
            {
              "id": "cfg-guide-note",
              "name": "guide_delivery_note",
              "value": "Le guide inclus avec votre commande est un document numÃ©rique (format e-book). Il nâ€™est pas envoyÃ© en version papier dans le colis.",
              "type": "string"
            },
            {
              "id": "cfg-apology-shipping",
              "name": "apology_livraison",
              "value": "Nous vous prÃ©sentons nos excuses pour ce contretemps de livraison et la gÃªne occasionnÃ©e.",
              "type": "string"
            },
            {
              "id": "cfg-apology-other",
              "name": "apology_autre",
              "value": "Nous vous prÃ©sentons nos excuses pour la gÃªne occasionnÃ©e.",
              "type": "string"
            },
            {
              "id": "cfg-refund-instruction-intro",
              "name": "refund_instruction_intro",
              "value": "Pour traiter votre demande, merci de nous transmettre les Ã©lÃ©ments suivants :",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "include": "=all",
        "options": {}
      },
      "id": "750ad7c8-e395-46a9-b357-92a7af51b99e",
      "name": "Client Configuration1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -9504,
        4864
      ]
    },
    {
      "parameters": {
        "resource": "draft",
        "subject": "={{ $('Client Configuration1').first().json.brand_name }} â€“ Suivi de votre commande",
        "message": "={{ $json.output }}\n",
        "options": {
          "threadId": "={{ $json.threadId || $json.ThreadId || $(\"Nouveau Email ReÃ§u1\").item.json.threadId || $(\"Nouveau Email ReÃ§u1\").item.json.ThreadId }}",
          "sendTo": "={{ $json.validated_send_to || $json.reply_to_recipient_raw || $json.reply_to_recipient || $json['Reply-To'] || $json.From || $json.reply_to_email || $json.client_email || $json.from || $(\"Nouveau Email ReÃ§u1\").item.json['Reply-To'] || $(\"Nouveau Email ReÃ§u1\").item.json.From || $(\"Nouveau Email ReÃ§u1\").item.json.from }}"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -6528,
        3536
      ],
      "id": "8079a776-ea18-46d3-92c2-e61e22d4c2d4",
      "name": "Create a draft1",
      "webhookId": "9519ebdb-6aeb-4834-b4a3-4c600a3fc50e",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "credentials": {
        "gmailOAuth2": {
          "id": "ZiybzjxKNB9gi1CO",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "resource": "draft",
        "subject": "={{ $('Client Configuration1').first().json.brand_name }} â€“ RÃ©ponse Ã  votre message",
        "message": "={{ $json.output }}\n",
        "options": {
          "threadId": "={{ $json.threadId || $json.ThreadId || $(\"Nouveau Email ReÃ§u1\").item.json.threadId || $(\"Nouveau Email ReÃ§u1\").item.json.ThreadId }}",
          "sendTo": "={{ $json.validated_send_to || $json.reply_to_recipient_raw || $json.reply_to_recipient || $json['Reply-To'] || $json.From || $json.reply_to_email || $json.client_email || $json.from || $(\"Nouveau Email ReÃ§u1\").item.json['Reply-To'] || $(\"Nouveau Email ReÃ§u1\").item.json.From || $(\"Nouveau Email ReÃ§u1\").item.json.from }}"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -6944,
        4928
      ],
      "id": "d3602d50-c857-4fbc-b279-65359511be97",
      "name": "Create a draft3",
      "webhookId": "9519ebdb-6aeb-4834-b4a3-4c600a3fc50e",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "credentials": {
        "gmailOAuth2": {
          "id": "ZiybzjxKNB9gi1CO",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "responses": {
          "values": [
            {
              "content": "=RÃ©dige un brouillon dâ€™email professionnel en franÃ§ais pour rÃ©pondre Ã  une demande de remboursement.\n\nRÃ¨gles obligatoires :\n- Ton formel (vouvoiement obligatoire)\n- Ne jamais accepter ni refuser le remboursement\n- Indiquer que la demande est en cours dâ€™analyse\n- Ne fixer aucun dÃ©lai\n- Ne faire aucune promesse\n- Inclure explicitement cette phrase d'instruction (sans la reformuler) : {{ $node[\"Client Configuration1\"].json.refund_instruction_intro }}\n- Demander systÃ©matiquement :\n{{ $node[\"Client Configuration1\"].json.refund_required_items }}\n\nContexte destinataire :\n- Nom : {{ $json.client_name || $node[\"Nouveau Email ReÃ§u1\"].json.client_name || $node[\"Nouveau Email ReÃ§u1\"].json.From }}\n- Email : {{ $json.client_email || $json.from || $node[\"Nouveau Email ReÃ§u1\"].json.From }}\n- Sujet reÃ§u : {{ $json.subject || $node[\"Nouveau Email ReÃ§u1\"].json.Subject || $json.subject }}\n\nMarque : {{ $node[\"Client Configuration1\"].json.brand_name }}\nSignature : {{ $node[\"Client Configuration1\"].json.support_signature }}\n\nDemande client :\n{{ $json.resume }}"
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        -7456,
        4192
      ],
      "id": "ca7cd42c-dc2a-48ff-aa1e-33c35cf0701b",
      "name": "Draft â€“ Remboursement1",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "credentials": {
        "openAiApi": {
          "id": "a1M3DJWKMxTixZzN",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "resource": "draft",
        "subject": "={{ $node[\"Client Configuration1\"].json.brand_name }} â€“ Suivi de votre demande de remboursement",
        "message": "={{ typeof $json.output === 'string' ? $json.output : ($json.output?.[0]?.content?.[0]?.text || $json.content?.[0]?.text || $json.text || '') }}\\n",
        "options": {
          "threadId": "={{ $json.threadId || $json.ThreadId || $(\"Nouveau Email ReÃ§u1\").item.json.threadId }}",
          "sendTo": "={{ $json.validated_send_to || $json.reply_to_recipient_raw || $json.reply_to_recipient || $json['Reply-To'] || $json.From || $json.reply_to_email || $json.client_email || $json.from || $(\"Nouveau Email ReÃ§u1\").item.json['Reply-To'] || $(\"Nouveau Email ReÃ§u1\").item.json.From }}"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -6672,
        4112
      ],
      "id": "6e011eca-ec70-4f17-b29d-5b5278bcf043",
      "name": "Create Draft â€“ Remboursement1",
      "webhookId": "180f8818-5838-4ac3-964f-2ad1b8842f25",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "credentials": {
        "gmailOAuth2": {
          "id": "ZiybzjxKNB9gi1CO",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $node[\"Client Configuration1\"].json.review_chat_id || \"7651454520\" }}",
        "text": "=ðŸ’¸ NOUVELLE DEMANDE DE REMBOURSEMENT  ðŸ‘¤ Client : {{ $json.client_name }} ðŸ“§ Email : {{ $json.client_email }} ðŸ“¦ Commande / Colis : {{ $json.order_number }}  ðŸ“ RÃ©sumÃ© : {{ $json.resume }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -5472,
        4176
      ],
      "id": "37b2f0c2-7763-4b42-861b-ed5bcb560093",
      "name": "Send a text message1",
      "webhookId": "247d3ecc-5ddf-4e4a-93f8-4d7c32e9f156",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "credentials": {
        "telegramApi": {
          "id": "vEsMlILzv1qHRMAX",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const sourceEmails = $items(\"Nouveau Email ReÃ§u1\");\nconst inItems = $input.all();\n\nreturn inItems.map((item, index) => {\n  const emailItem = sourceEmails[index]?.json || sourceEmails[0]?.json || {};\n  const fromRaw = item.json.from || item.json.From || emailItem.From || emailItem.from || '';\n  const emailMatch = fromRaw.match(/<(.+?)>/);\n  const email = emailMatch ? emailMatch[1] : (fromRaw || 'Email non disponible');\n  const name = fromRaw.split('<')[0]?.trim() || 'Client non identifiÃ©';\n\n  const fullText =\n    item.json.text ||\n    item.json.snippet ||\n    item.json.body ||\n    item.json.subject ||\n    emailItem.text ||\n    emailItem.snippet ||\n    emailItem.body ||\n    emailItem.subject ||\n    '';\n\n  const orderRegex = /(commande|cmd|order|colis|#)\\s*(nÂ°|no|numÃ©ro|number)?\\s*[:#-]?\\s*([A-Z0-9-]{3,})/i;\n  const match = fullText.match(orderRegex);\n  const orderNumber = match ? match[3] : 'Non communiquÃ©';\n\n  return {\n    json: {\n      ...item.json,\n      client_name: name,\n      client_email: email,\n      order_number: orderNumber,\n      resume: item.json.resume || 'Demande de remboursement'\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5840,
        4160
      ],
      "id": "443f5feb-4f91-444d-b48a-152f9fc2006b",
      "name": "Prepare Telegram â€“ Remboursement1"
    },
    {
      "parameters": {
        "jsCode": "const store = $getWorkflowStaticData('global');\nstore.processedMessages ??= {};\nconst now = Date.now();\nconst retentionMs = 14 * 24 * 60 * 60 * 1000;\nfor (const [k, ts] of Object.entries(store.processedMessages)) {\n  if (typeof ts !== 'number' || now - ts > retentionMs) delete store.processedMessages[k];\n}\n\nfunction normalizeLineBreaks(value) {\n  return (value || '').toString().replaceAll('\\r', ' ').replaceAll('\\n', ' ').trim();\n}\n\nfunction parseAddress(rawValue) {\n  const raw = normalizeLineBreaks(rawValue);\n  if (!raw) return { name: '', email: '', raw: '' };\n\n  const angle = raw.match(/^\\s*\"?([^\"<]*)\"?\\s*<\\s*([^>]+)\\s*>\\s*$/);\n  if (angle) {\n    const name = (angle[1] || '').trim().replace(/^\"+|\"+$/g, '');\n    const email = (angle[2] || '').trim().toLowerCase();\n    const normalized = name ? `${name} <${email}>` : email;\n    return { name, email, raw: normalized };\n  }\n\n  const first = raw.split(',')[0].trim();\n  const emailMatch = first.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}/i);\n  const email = emailMatch ? emailMatch[0].toLowerCase() : '';\n  return { name: '', email, raw: first };\n}\n\nfunction hashString(input) {\n  const str = (input || '').toString();\n  let h = 2166136261;\n  for (let i = 0; i < str.length; i++) {\n    h ^= str.charCodeAt(i);\n    h += (h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24);\n  }\n  return (h >>> 0).toString(16).padStart(8, '0');\n}\n\nconst fromRaw = $json.From || $json.from || '';\nconst replyToRaw = $json['Reply-To'] || $json.replyTo || $json.reply_to || '';\nconst fromAddr = parseAddress(fromRaw);\nconst replyAddr = parseAddress(replyToRaw);\n\nconst headerMessageId = $json.messageId || $json.id || $json['Message-ID'] || $json.message_id || $json.gmailMessageId || '';\nconst threadId = $json.threadId || $json.ThreadId || '';\nconst subject = ($json.subject || $json.Subject || '').toString();\nconst sentDate = ($json.date || $json.Date || $json.internalDate || '').toString();\nconst bodySeed = ($json.snippet || $json.text || $json.body || '').toString().slice(0, 280);\nconst fallbackFingerprint = `${threadId}|${fromRaw}|${subject}|${sentDate}|${bodySeed}`;\nconst messageKey = headerMessageId ? headerMessageId.toString() : `fp:${hashString(fallbackFingerprint)}`;\n\nif (store.processedMessages[messageKey]) return [];\nstore.processedMessages[messageKey] = now;\n\nconst clientEmail = fromAddr.email || (fromRaw || 'Email non disponible');\nconst clientName = fromAddr.name || (fromRaw.split('<')[0]?.trim() || 'Client non identifie');\n\nconst replyToEmail = replyAddr.email || fromAddr.email || $json.client_email || clientEmail;\nconst replyToName = (replyAddr.name || fromAddr.name || $json.client_name || clientName || '')\n  .toString()\n  .trim()\n  .replace(/^\"+|\"+$/g, '')\n  .replaceAll('<', '')\n  .replaceAll('>', '')\n  .replaceAll('\\r', '')\n  .replaceAll('\\n', '');\n\nconst replyToRecipient = replyToName && replyToEmail\n  ? `${replyToName} <${replyToEmail}>`\n  : replyToEmail;\n\nconst replyToRecipientRaw = (replyAddr.raw || fromAddr.raw || replyToRecipient || '')\n  .toString()\n  .replaceAll('\\r', ' ')\n  .replaceAll('\\n', ' ')\n  .trim();\n\nconst text = ($json.text || $json.body || $json.snippet || $json.subject || '').toString();\nconst orderRegex = /(commande|cmd|order|colis|#)\\s*(nÂ°|no|numero|number)?\\s*[:#-]?\\s*([A-Z0-9-]{3,})/i;\nconst orderMatch = text.match(orderRegex);\nconst orderNumber = orderMatch ? orderMatch[3] : 'Non communique';\n\nreturn [{\n  json: {\n    ...$json,\n    message_key: messageKey,\n    client_name: $json.client_name || clientName,\n    client_email: $json.client_email || clientEmail,\n    reply_to_name: replyToName || $json.client_name || clientName,\n    reply_to_email: replyToEmail,\n    reply_to_recipient: replyToRecipient,\n    reply_to_recipient_raw: replyToRecipientRaw,\n    order_number: $json.order_number || orderNumber,\n    intake_is_duplicate: false\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9168,
        4896
      ],
      "id": "37f829e3-d536-4414-8d05-ced6110d6215",
      "name": "Intake Guard + Context1"
    }
  ],
  "pinData": {},
  "connections": {
    "Nouveau Email ReÃ§u1": {
      "main": [
        [
          {
            "node": "Client Configuration1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Client Configuration1": {
      "main": [
        [
          {
            "node": "Intake Guard + Context1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Intake Guard + Context1": {
      "main": [
        [
          {
            "node": "Analyse Email - Classification1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Analyse Email - Classification1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Analyse Email - Classification1": {
      "main": [
        [
          {
            "node": "Parse IA Outpu1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse IA Outpu1": {
      "main": [
        [
          {
            "node": "triage mail 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "triage mail 1": {
      "main": [
        [
          {
            "node": "Draft â€“ Livraison1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Draft â€“ Remboursement1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Draft â€“ Autre1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "Draft â€“ Livraison1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Draft â€“ Livraison1": {
      "main": [
        [
          {
            "node": "Create a draft1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "Draft â€“ Autre1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Draft â€“ Autre1": {
      "main": [
        [
          {
            "node": "Create a draft3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Draft â€“ Remboursement1": {
      "main": [
        [
          {
            "node": "Create Draft â€“ Remboursement1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Draft â€“ Remboursement1": {
      "main": [
        [
          {
            "node": "Prepare Telegram â€“ Remboursement1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Telegram â€“ Remboursement1": {
      "main": [
        [
          {
            "node": "Send a text message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "versionId": "aceea242-6114-4919-80c5-a6fbd62dc6dc",
  "meta": {
    "instanceId": "1660efa09ebdcf6270315253695cc362a265d2b1d2c3fe1761bd1a4e4e70512a"
  },
  "id": "ZlUtwCB6NmTVXS6k",
  "tags": []
}
